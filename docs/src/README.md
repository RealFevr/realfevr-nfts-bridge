# RealFevr bridge

### Requirements
- Foundry from [here](https://github.com/foundry-rs/foundry/)

## Architecture
The bridge is composed of three main components:

- The bridge contract, which is deployed on supported chains and it's the scope of this documentation.
- The bridge UI, which is a web application that allows users to interact with the bridge contract.
- The bridge server, which is a server that listens to events emitted by the bridge contract and performs the actual transfer of assets between chains.

## Run Scripts

```
forge script forge script .\script\BridgeERC20Impl.s.sol:DeployAllAndSetBridgeERC20
```
to point a chain, add `-f "https://RPCLINK"` to the command
to broadcast the transaction on chain, add `--broadcast` to the command

## Run Tests

To run tests we use Foundry from Paradigm. To install it, follow the instructions [here](https://book.getfoundry.sh/getting-started/installation)
If you're using Windows you can download the binaries and add them to your PATH, without needing to install and compile the project.

Install the required libraries and edit the foundry.toml remapping based on your local setup.
```
forge install foundry-rs/forge-std --no-commit
forge install openzeppelin/openzeppelin-contracts --no-commit
```
To execute a test, run `forge test`

# ERC721 Bridge

## user usage actions (contract related)

1. User approves the bridge contract to transfer the NFTs
2. User calls depositSingleERC721 with the NFT address & tokenID (paying the fees in ERC20 & ETH if active)
3. Bridge backend listen for and register the deposit event
4. Bridge signer calls calls withdrawSingleERC721 with the NFT address & tokenID

## admin usage actions (contract related)

### Initialization

To initialize the contract, the project owner needs to call the `initialize` function with the following parameters:

- `_bridgeSigner`: Address of the signer of the bridge.
- `_feeReceiver`: Address of the fee receiver.
- `_operator`: Address of the operator.

### Setting Supported Chains

The operator can set the supported chains using the `setSupportedChain` function. This function accepts the `chainId` of the chain and a `status` (true/false) to enable or disable the chain.

### Setting Max NFTs Per Transaction

The operator can set the maximum number of NFTs that can be used in a single transaction using the `setMaxNFTsPerTx` function. This function accepts the `maxNFTsPerTx` parameter, which represents the maximum number of NFTs allowed per transaction.

### Setting Bridge Status

The operator can set the bridge status (online/offline) using the `setBridgeStatus` function. This function accepts a boolean value (`true` for online, `false` for offline) to activate or deactivate the bridge.

### Setting Fee Status

The operator can set the fee status (active/inactive) using the `setFeeStatus` function. This function accepts a boolean value (`true` for active, `false` for inactive) to activate or deactivate the fees.

### Setting ETH Fees

The operator can set the ETH deposit fees for specific chain IDs using the `setETHFee` function. This function accepts the `chainId` of the chain, a boolean value (`true` for active, `false` for inactive), and the `amount` of the fee.

### Setting Token Fees

The operator can set the fees for ERC20 tokens using the `setTokenFees` function. This function accepts the following parameters:

- `active`: Boolean value (`true` for active, `false` for inactive) to activate or deactivate the fees.
- `nftAddress`: Address of the NFT token.
- `depositFee`: Fee amount for depositing the NFT token.
- `withdrawFee`: Fee amount for withdrawing the NFT token.

### Setting Fee Receiver

The operator can set the address of the fee receiver using the `setFeeReceiver` function. This function accepts the `receiver` parameter, which represents the address of the fee receiver.

### Setting NFT Details

The operator can set the details of an NFT address using the `setNFTDetails` function. This function accepts the following parameters:

- `isActive`: Boolean value (`true` for active, `false` for inactive) to activate or deactivate the NFT contract.
- `nftContractAddress`: Address of the NFT contract.
- `feeTokenAddress`: Address of the token used to pay the fee.
- `depositFeeAmount`: Deposit fee amount for the NFT contract.
- `withdrawFeeAmount`: Withdraw fee amount for the NFT contract.

### Setting ERC20 Details

The operator can set the details of an ERC20 address using the `setERC20Details` function. This function accepts the following parameters:

- `isActive`: Boolean value (`true` for active, `false` for inactive) to activate or deactivate the ERC20 contract.
- `erc20ContractAddress`: Address of the ERC20 contract.

### Withdrawing ERC721 Tokens

The bridge signer can withdraw ERC721 tokens from the bridge using the `withdrawSingleERC721` function. This function requires the following parameters:

- `to`: Address of the user to withdraw to.
- `nftContractAddress`: Address of the NFT contract.
- `tokenId`: ID of the NFT token.
- `uniqueKey`: Unique key associated with the withdrawal.

### Minting ERC721 Tokens

The bridge signer can mint ERC721 tokens using the `mintERC721` function. This function requires the following parameters:

- `nftAddress`: Address of the NFT contract.
- `to`: Address of the user to mint to.
- `tokenId`: ID of the NFT token.
- `uniqueKey`: Unique key associated with the minting.
- `_marketplaceDistributionRates`: Array of `uint16` values representing the marketplace distribution rates.
- `_marketplaceDistributionAddresses`: Array of addresses representing the marketplace distribution addresses.

### Setting Base URI

The operator can set the base URI of an NFT contract using the `setBaseURI` function. This function requires the following parameters:

- `nftAddress`: Address of the NFT contract.
- `baseURI_`: Base URI string.

### Changing NFT Contract Owner

The operator can change the owner of an NFT contract using the `changeOwnerNft` function. This function requires the following parameters:

- `nftAddress`: Address of the NFT contract.
- `newOwner`: Address of the new owner.

# ERC20 Bridge

## Initialization

To initialize the contract, the project owner needs to call the `initialize` function with the following parameters:

- `_bridgeSigner`: Address of the signer of the bridge.
- `_feeReceiver`: Address of the fee receiver.
- `_operator`: Address of the operator.

## Setting Supported Chains

The operator can set the supported chains using the `setSupportedChain` function. This function accepts the `chainId` of the chain and a `status` (true/false) to enable or disable the chain.

## Setting Bridge Status

The operator can set the bridge status (online/offline) using the `setBridgeStatus` function. This function accepts a boolean value to activate or deactivate the bridge.

## Setting Fee Status

The operator can set the bridge fee status (active/inactive) using the `setFeeStatus` function. This function accepts a boolean value to activate or deactivate the fees.

## Setting ETH Fee

The operator can set the ETH fee for a specific chain using the `setETHFee` function. This function accepts the `chainId` of the chain, a boolean value to activate or deactivate the fees, and the fee amount.

## Setting Token Fees

The operator can set the fees for ERC20 tokens using the `setTokenFees` function. This function accepts the `tokenAddress` of the token contract, the deposit fee amount, the withdraw fee amount, and the target chain id.

## Setting Fee Receiver

The operator can set the fee receiver address using the `setFeeReceiver` function. This function accepts the `receiver` address.

## Setting ERC20 Details

The operator can set the settings of an ERC20 token using the `setERC20Details` function. This function accepts the `tokenAddress` of the ERC20 contract, a boolean value to activate or deactivate the contract, a boolean value to burn the tokens on deposit, the deposit fee amount, the withdraw fee amount, the maximum deposit amount per 24 hours, the maximum withdraw amount per 24 hours, the maximum mint amount per 24 hours, the maximum burn amount per 24 hours, and the target chain id.

## Depositing ERC20 Tokens

Users can deposit ERC20 tokens to the bridge by calling the `depositERC20` function. This function accepts the `tokenAddress` of the token contract, the token amount, and the target chain id.

## Withdrawing ERC20 Tokens

The bridge can withdraw ERC20 tokens by calling the `withdrawERC20` function. This function accepts the `tokenAddress` of the token contract, the user address, the token amount, and a unique key.

## Getting Deposit Fee Amount

The project owner can get the amount of deposit fees for a given ERC20 contract by calling the `getDepositFeeAmount` function. This function accepts the `contractAddress` of the ERC20 contract and the target chain id.

## Getting Withdraw Fee Amount

The project owner can get the amount of withdraw fees for a given ERC20 contract by calling the `getWithdrawFeeAmount` function. This function accepts the `contractAddress` of the ERC20 contract and the target chain id.

### Contracts Table

|  Contract  |         Type        |       Bases      |                  |                 |
|:----------:|:-------------------:|:----------------:|:----------------:|:---------------:|
|     ‚îî      |  **Function Name**  |  **Visibility**  |  **Mutability**  |  **Modifiers**  |
||||||
| **ERC721BridgeImpl** | Implementation | ERC721Holder, AccessControlUpgradeable, ReentrancyGuardUpgradeable, UUPSUpgradeable |||
| ‚îî | <Constructor> | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | _authorizeUpgrade | Internal üîí | üõë  | onlyRole |
| ‚îî | initialize | External ‚ùóÔ∏è | üõë  | initializer |
| ‚îî | setSupportedChain | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setMaxNFTsPerTx | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setBridgeStatus | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setFeeStatus | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setETHFee | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setTokenFees | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setFeeReceiver | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setNFTDetails | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setERC20Details | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | depositSingleERC721 | Public ‚ùóÔ∏è |  üíµ |NO‚ùóÔ∏è |
| ‚îî | depositMultipleERC721 | External ‚ùóÔ∏è |  üíµ | nonReentrant |
| ‚îî | withdrawSingleERC721 | Public ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | withdrawMultipleERC721 | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | takeFees | Private üîê | üõë  | |
| ‚îî | getDepositFeeAddressAndAmount | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | createERC721 | Public ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | mintERC721 | Public ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setMarketplaceDistributions | Public ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setBaseURI | Public ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | changeOwnerNft | Public ‚ùóÔ∏è | üõë  | onlyRole |
||||||
| **base_erc721** | Implementation | ERC721, Ownable |||
| ‚îî | <Constructor> | Public ‚ùóÔ∏è | üõë  | ERC721 Ownable |
| ‚îî | safeMint | Public ‚ùóÔ∏è | üõë  | onlyOwner |
| ‚îî | safeMintTo | Public ‚ùóÔ∏è | üõë  | onlyOwner |
| ‚îî | setBaseURI | Public ‚ùóÔ∏è | üõë  | onlyOwner |
| ‚îî | setMarketplaceDistributions | External ‚ùóÔ∏è | üõë  | onlyOwner |
| ‚îî | _baseURI | Internal üîí |   | |
| ‚îî | getMarketplaceDistributionForERC721 | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
||||||
| **BridgeERC721_test** | Implementation | BaseTest |||
| ‚îî | setUp | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | createToken | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | onERC721Received | Public ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | test_check_deployment_initialization | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setSupportedChain | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setMaxNFTsPerTx | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setBridgeStatus | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setFeeStatus | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setETHFee | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setTokenFees | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setFeeReceiver | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setNFTDetails | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setERC20Details | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_depositSingleERC721 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_depositMultipleERC721 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_depositMultipleERC721_withFees | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_withdrawSingleERC721 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_withdrawMultipleERC721 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_getDepositFeeAddressAndAmount | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_setBaseURI | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | test_changeOwnerNft | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **BaseTest** | Implementation | Test |||
||||||
| **base_erc20** | Implementation | ERC20, Ownable, ERC20Capped |||
| ‚îî | <Constructor> | Public ‚ùóÔ∏è | üõë  | ERC20 ERC20Capped Ownable |
| ‚îî | decimals | Public ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | airdrop | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | airdropD | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | mint | External ‚ùóÔ∏è | üõë  | onlyOwner |
| ‚îî | burn | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | _update | Internal üîí | üõë  | |
||||||
| **IERC20** | Interface |  |||
| ‚îî | decimals | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | balanceOf | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | transfer | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | transferFrom | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | allowance | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | burn | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **ERC20BridgeImpl** | Implementation | AccessControlUpgradeable, ReentrancyGuardUpgradeable, UUPSUpgradeable |||
| ‚îî | <Constructor> | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | _authorizeUpgrade | Internal üîí | üõë  | onlyRole |
| ‚îî | initialize | External ‚ùóÔ∏è | üõë  | initializer |
| ‚îî | setSupportedChain | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setBridgeStatus | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setFeeStatus | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setETHFee | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setTokenFees | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setFeeReceiver | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | setERC20Details | External ‚ùóÔ∏è | üõë  | onlyRole |
| ‚îî | depositERC20 | External ‚ùóÔ∏è |  üíµ | nonReentrant |
| ‚îî | withdrawERC20 | External ‚ùóÔ∏è | üõë  | nonReentrant |
| ‚îî | calculateFees | Private üîê |   | |
| ‚îî | getDepositFeeAmount | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | getWithdrawFeeAmount | External ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
| ‚îî | createNewToken | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | mintToken | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | burnToken | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **Base** | Implementation | Script |||
| ‚îî | attachContracts | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | deployBridge | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | deployERC20 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | deployERC721 | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | setNftDetails | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | setERC20Details | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | setBridgeStatus | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | setFeeStatus | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | setETHFee | Public ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
| ‚îî | showAddresses | Public ‚ùóÔ∏è |   |NO‚ùóÔ∏è |
||||||
| **DeployAllAndSetBridgeERC721Impl** | Implementation | Base |||
| ‚îî | run | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **DeployBridgeImpl** | Implementation | Base |||
| ‚îî | run | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **UpgradeBridgeImpl** | Implementation | Base |||
| ‚îî | run | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |
||||||
| **DepositInBridgeERC721Impl** | Implementation | Base |||
| ‚îî | run | External ‚ùóÔ∏è | üõë  |NO‚ùóÔ∏è |


 Legend

|  Symbol  |  Meaning  |
|:--------:|-----------|
|    üõë    | Function can modify state |
|    üíµ    | Function is payable |
